<div class="flex min-w-0 flex-auto flex-col p-6 sm:p-8">
    <div class="flex flex-wrap items-start justify-between gap-4">
        <div>
            <div class="text-2xl font-semibold tracking-tight">
                Historico de Price Snapshot
            </div>
            <div class="text-secondary">
                Fecha: {{ snapshotDate() }}
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <input
                class="date-input"
                type="date"
                [value]="selectedDate()"
                (change)="onDateChange($event)"
            />
            <button
                mat-stroked-button
                type="button"
                (click)="loadByDate()"
                [disabled]="loading() || !selectedDate()"
            >
                Consultar
            </button>
            <button
                mat-stroked-button
                type="button"
                (click)="loadLatest()"
                [disabled]="loading()"
            >
                Ultimo
            </button>
        </div>
    </div>

    @if (error().length > 0) {
        <div class="mt-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
            {{ error() }}
        </div>
    }

    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
                <div class="text-sm font-medium">Listado</div>
                <div class="text-secondary text-sm">
                    Mostrando {{ filteredCount() }} de {{ totalCount() }}
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2">
                    <span class="text-xs text-secondary">Desde</span>
                    <input
                        class="date-input"
                        type="date"
                        [value]="reportFrom()"
                        (change)="reportFrom.set($any($event.target).value)"
                    />
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-xs text-secondary">Hasta</span>
                    <input
                        class="date-input"
                        type="date"
                        [value]="reportTo()"
                        (change)="reportTo.set($any($event.target).value)"
                    />
                </div>
                <button
                    mat-flat-button
                    color="primary"
                    type="button"
                    (click)="exportExcel()"
                    [disabled]="exporting()"
                >
                    Exportar Excel
                </button>
            </div>
        </div>
        @if (exportError().length > 0) {
            <div class="mt-3 rounded-lg border border-red-200 bg-red-50 px-3 py-2 text-xs text-red-700">
                {{ exportError() }}
            </div>
        }

        <div class="mt-4 grid gap-4 lg:grid-cols-7">
            <mat-form-field class="w-full">
                <mat-label>SKU</mat-label>
                <input
                    matInput
                    placeholder="Buscar por SKU"
                    [value]="filterSku()"
                    (input)="filterSku.set($any($event.target).value)"
                />
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>EAN</mat-label>
                <input
                    matInput
                    placeholder="Buscar por EAN"
                    [value]="filterEan()"
                    (input)="filterEan.set($any($event.target).value)"
                />
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Nombre</mat-label>
                <input
                    matInput
                    placeholder="Buscar por descripcion"
                    [value]="filterName()"
                    (input)="filterName.set($any($event.target).value)"
                />
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Marca</mat-label>
                <mat-select
                    [value]="filterBrandId()"
                    (selectionChange)="filterBrandId.set($event.value)"
                >
                    <mat-option [value]="null">Todas</mat-option>
                    @for (item of brands(); track item.id) {
                        <mat-option [value]="item.id">{{ item.name }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Proveedor</mat-label>
                <mat-select
                    [value]="filterSupplierId()"
                    (selectionChange)="filterSupplierId.set($event.value)"
                >
                    <mat-option [value]="null">Todos</mat-option>
                    @for (item of suppliers(); track item.id) {
                        <mat-option [value]="item.id">{{ item.name }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Categoria</mat-label>
                <mat-select
                    [value]="filterCategoryId()"
                    (selectionChange)="filterCategoryId.set($event.value)"
                >
                    <mat-option [value]="null">Todas</mat-option>
                    @for (item of categories(); track item.id) {
                        <mat-option [value]="item.id">{{ item.name }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Linea</mat-label>
                <mat-select
                    [value]="filterLineId()"
                    (selectionChange)="filterLineId.set($event.value)"
                >
                    <mat-option [value]="null">Todas</mat-option>
                    @for (item of lines(); track item.id) {
                        <mat-option [value]="item.id">{{ item.name }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Competidor</mat-label>
                <mat-select
                    [value]="filterCompetitor()"
                    (selectionChange)="filterCompetitor.set($event.value)"
                >
                    <mat-option [value]="null">Todos</mat-option>
                    @for (item of competitors(); track item.id) {
                        <mat-option [value]="item.id">{{ item.name }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Estado</mat-label>
                <mat-select
                    [value]="filterStatus()"
                    (selectionChange)="filterStatus.set($event.value)"
                >
                    <mat-option value="all">Todos</mat-option>
                    <mat-option value="matched">Con match</mat-option>
                    <mat-option value="unmatched">Sin match</mat-option>
                    <mat-option value="no-ean">Sin EAN</mat-option>
                </mat-select>
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Alerta</mat-label>
                <mat-select
                    [value]="filterAlert()"
                    (selectionChange)="filterAlert.set($event.value)"
                >
                    <mat-option value="all">Todos</mat-option>
                    <mat-option value="with">Con alerta</mat-option>
                    <mat-option value="without">Sin alerta</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="mt-2">
            <button mat-stroked-button type="button" (click)="resetFilters()">
                Limpiar filtros
            </button>
        </div>
    </div>

    @if (!hasRows() && !loading()) {
        <div class="mt-6 rounded-xl border border-dashed border-slate-300 bg-white px-6 py-8 text-center text-sm text-secondary">
            No hay snapshots disponibles para la fecha seleccionada.
        </div>
    }

    @if (hasRows() && !hasItems() && !loading()) {
        <div class="mt-6 rounded-xl border border-dashed border-slate-300 bg-white px-6 py-8 text-center text-sm text-secondary">
            No hay productos para los filtros seleccionados.
        </div>
    }

    @if (hasItems()) {
        <div class="mt-6 overflow-hidden rounded-2xl border border-slate-200 bg-white">
            <table class="snapshot-table w-full">
                <thead>
                    <tr>
                        <th class="sticky-col" rowspan="2">Producto</th>
                        <th class="sticky-col" rowspan="2">EAN</th>
                        @for (competitor of competitors(); let i = $index; track competitor.id) {
                            <th
                                class="competitor-group"
                                [attr.colspan]="3"
                                [style.backgroundColor]="getCompetitorColor(i, competitor)"
                            >
                                {{ competitor.name }}
                            </th>
                        }
                    </tr>
                    <tr>
                        @for (competitor of competitors(); let i = $index; track competitor.id) {
                            <th
                                class="competitor-sub"
                                [style.backgroundColor]="getCompetitorColor(i, competitor)"
                            >
                                Precio lista
                            </th>
                            <th
                                class="competitor-sub"
                                [style.backgroundColor]="getCompetitorColor(i, competitor)"
                            >
                                Precio promo
                            </th>
                            <th
                                class="competitor-sub"
                                [style.backgroundColor]="getCompetitorColor(i, competitor)"
                            >
                                URL
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @for (row of filteredRowsView(); track row.productId) {
                        <tr>
                            <td class="sticky-col">
                                <div class="font-medium">{{ row.description }}</div>
                                <div class="text-xs text-secondary">
                                    Marca: {{ row.brandName ?? '—' }}
                                </div>
                                <div class="text-xs text-secondary">
                                    Proveedor: {{ row.supplierName ?? '—' }}
                                </div>
                                <div class="text-xs text-secondary">
                                    Categoria: {{ row.categoryName ?? '—' }}
                                </div>
                                <div class="text-xs text-secondary">
                                    Linea: {{ row.lineName ?? '—' }}
                                </div>
                                <div class="text-xs text-secondary">SKU: {{ row.sku ?? '—' }}</div>
                            </td>
                            <td class="sticky-col">{{ row.ean ?? '—' }}</td>
                            @for (competitor of competitors(); let i = $index; track competitor.id) {
                                <td
                                    class="competitor-cell"
                                    [style.backgroundColor]="getCompetitorColor(i, competitor)"
                                    [class.delta-alert]="isLargeDelta(row.deltaListByCompetitor[competitor.id], row.brandName ?? null, 'list')"
                                >
                                    @if (row.pricesByCompetitor[competitor.id]?.listPrice !== null &&
                                    row.pricesByCompetitor[competitor.id]?.listPrice !== undefined) {
                                        <div class="price-stack">
                                            <div class="price-main">
                                                {{ row.pricesByCompetitor[competitor.id]?.listPrice | number: '1.0-0' }}
                                            </div>
                                            @if (
                                            (row.deltaListByCompetitor[competitor.id]?.amount !== null &&
                                            row.deltaListByCompetitor[competitor.id]?.amount !== undefined) ||
                                            (row.deltaListByCompetitor[competitor.id]?.percent !== null &&
                                            row.deltaListByCompetitor[competitor.id]?.percent !== undefined)
                                            ) {
                                                <div
                                                    class="delta-stack"
                                                    [class.delta-up]="(row.deltaListByCompetitor[competitor.id]?.amount ?? 0) > 0"
                                                    [class.delta-down]="(row.deltaListByCompetitor[competitor.id]?.amount ?? 0) < 0"
                                                    [class.delta-flat]="(row.deltaListByCompetitor[competitor.id]?.amount ?? 0) === 0"
                                                >
                                                    <div class="delta-cell">
                                                        <span class="delta-indicator">
                                                            @if (row.deltaListByCompetitor[competitor.id]?.amount > 0) { ▲ } @else if (row.deltaListByCompetitor[competitor.id]?.amount < 0) { ▼ } @else { ● }
                                                        </span>
                                                        <span class="delta-value">
                                                            {{ row.deltaListByCompetitor[competitor.id]?.amount > 0 ? '+' : '' }}{{ row.deltaListByCompetitor[competitor.id]?.amount | number: '1.0-0' }}
                                                        </span>
                                                    </div>
                                                    <div class="delta-sub">
                                                        {{ row.deltaListByCompetitor[competitor.id]?.percent > 0 ? '+' : '' }}{{ row.deltaListByCompetitor[competitor.id]?.percent | number: '1.1-1' }}%
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    } @else {
                                        —
                                    }
                                </td>
                                <td
                                    class="competitor-cell"
                                    [style.backgroundColor]="getCompetitorColor(i, competitor)"
                                    [class.delta-alert]="isLargeDelta(row.deltaPromoByCompetitor[competitor.id], row.brandName ?? null, 'promo')"
                                >
                                    @if (row.pricesByCompetitor[competitor.id]?.promoPrice !== null &&
                                    row.pricesByCompetitor[competitor.id]?.promoPrice !== undefined) {
                                        <div class="price-stack">
                                            <div class="price-main">
                                                {{ row.pricesByCompetitor[competitor.id]?.promoPrice | number: '1.0-0' }}
                                            </div>
                                            @if (
                                            (row.deltaPromoByCompetitor[competitor.id]?.amount !== null &&
                                            row.deltaPromoByCompetitor[competitor.id]?.amount !== undefined) ||
                                            (row.deltaPromoByCompetitor[competitor.id]?.percent !== null &&
                                            row.deltaPromoByCompetitor[competitor.id]?.percent !== undefined)
                                            ) {
                                                <div
                                                    class="delta-stack"
                                                    [class.delta-up]="(row.deltaPromoByCompetitor[competitor.id]?.amount ?? 0) > 0"
                                                    [class.delta-down]="(row.deltaPromoByCompetitor[competitor.id]?.amount ?? 0) < 0"
                                                    [class.delta-flat]="(row.deltaPromoByCompetitor[competitor.id]?.amount ?? 0) === 0"
                                                >
                                                    <div class="delta-cell">
                                                        <span class="delta-indicator">
                                                            @if (row.deltaPromoByCompetitor[competitor.id]?.amount > 0) { ▲ } @else if (row.deltaPromoByCompetitor[competitor.id]?.amount < 0) { ▼ } @else { ● }
                                                        </span>
                                                        <span class="delta-value">
                                                            {{ row.deltaPromoByCompetitor[competitor.id]?.amount > 0 ? '+' : '' }}{{ row.deltaPromoByCompetitor[competitor.id]?.amount | number: '1.0-0' }}
                                                        </span>
                                                    </div>
                                                    <div class="delta-sub">
                                                        {{ row.deltaPromoByCompetitor[competitor.id]?.percent > 0 ? '+' : '' }}{{ row.deltaPromoByCompetitor[competitor.id]?.percent | number: '1.1-1' }}%
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    } @else {
                                        —
                                    }
                                </td>
                                <td
                                    class="competitor-cell"
                                    [style.backgroundColor]="getCompetitorColor(i, competitor)"
                                >
                                    @if (row.pricesByCompetitor[competitor.id]?.url) {
                                        <a
                                            class="text-primary-700 underline"
                                            [href]="row.pricesByCompetitor[competitor.id]?.url"
                                            target="_blank"
                                        >
                                            Ver producto
                                        </a>
                                    } @else {
                                        —
                                    }
                                    <div class="mt-1 text-[11px] text-slate-700">
                                        {{ getMatchMethodLabel(row.pricesByCompetitor[competitor.id]?.matchMethod) }}
                                    </div>
                                    <button
                                        class="mt-2 text-[11px] underline text-primary-700"
                                        type="button"
                                        (click)="openQuickEdit(row)"
                                    >
                                        Editar producto
                                    </button>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@if (editorOpen()) {
    <div
        class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 p-4"
        (click)="closeQuickEdit()"
    >
        <div
            class="max-h-[90vh] w-full max-w-5xl overflow-auto rounded-2xl bg-white p-6 shadow-2xl"
            (click)="$event.stopPropagation()"
        >
            <div class="flex items-start justify-between gap-3">
                <div>
                    <div class="text-lg font-semibold">Edicion rapida de producto</div>
                    <div class="text-sm text-secondary">
                        {{ editorData()?.product?.description ?? 'Cargando...' }}
                    </div>
                </div>
                <button mat-stroked-button type="button" (click)="closeQuickEdit()">
                    Cerrar
                </button>
            </div>

            @if (editorError().length > 0) {
                <div class="mt-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
                    {{ editorError() }}
                </div>
            }

            @if (editorLoading()) {
                <div class="mt-4 text-sm text-secondary">Cargando detalle...</div>
            }

            @if (!editorLoading() && editorData()) {
                <div class="mt-4 grid gap-3 rounded-xl border border-slate-200 bg-slate-50 p-4 sm:grid-cols-4">
                    <div>
                        <div class="text-[11px] uppercase text-secondary">SKU</div>
                        <div class="font-medium">{{ editorData()?.product?.sku ?? '—' }}</div>
                    </div>
                    <div>
                        <div class="text-[11px] uppercase text-secondary">EAN</div>
                        <div class="font-medium">{{ editorData()?.product?.ean ?? '—' }}</div>
                    </div>
                    <div>
                        <div class="text-[11px] uppercase text-secondary">Marca</div>
                        <div class="font-medium">{{ editorData()?.product?.brand ?? '—' }}</div>
                    </div>
                    <div>
                        <div class="text-[11px] uppercase text-secondary">Categoria</div>
                        <div class="font-medium">{{ editorData()?.product?.category ?? '—' }}</div>
                    </div>
                </div>

                <div class="mt-4 overflow-auto rounded-xl border border-slate-200">
                    <table class="w-full min-w-[860px]">
                        <thead>
                            <tr>
                                <th>Competidor</th>
                                <th>Precio lista</th>
                                <th>Precio promo</th>
                                <th>Metodo</th>
                                <th>URL</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (row of editorRows(); track row.competitor.id) {
                                <tr>
                                    <td class="font-medium">{{ row.competitor.name }}</td>
                                    <td>
                                        @if (row.latest?.listPrice !== null && row.latest?.listPrice !== undefined) {
                                            {{ row.latest?.listPrice | number: '1.0-0' }}
                                        } @else {
                                            —
                                        }
                                    </td>
                                    <td>
                                        @if (row.latest?.promoPrice !== null && row.latest?.promoPrice !== undefined) {
                                            {{ row.latest?.promoPrice | number: '1.0-0' }}
                                        } @else {
                                            —
                                        }
                                    </td>
                                    <td>
                                        {{ getMatchMethodLabel(row.latest?.matchMethod) }}
                                    </td>
                                    <td>
                                        @if (row.latest?.url) {
                                            <a
                                                class="text-primary-700 underline"
                                                [href]="row.latest?.url"
                                                target="_blank"
                                            >
                                                Ver producto
                                            </a>
                                        } @else {
                                            —
                                        }

                                        <div class="mt-2 flex flex-col gap-2">
                                            <mat-form-field class="w-full" appearance="outline">
                                                <mat-label>URL</mat-label>
                                                <input
                                                    matInput
                                                    [value]="getEditorUrlDraft(row.competitor.id, row.latest?.url ?? null)"
                                                    (input)="onEditorUrlChange(row.competitor.id, $any($event.target).value)"
                                                />
                                            </mat-form-field>
                                            <button
                                                mat-stroked-button
                                                type="button"
                                                (click)="saveEditorUrl(row.competitor.id)"
                                                [disabled]="isEditorSaving(row.competitor.id)"
                                            >
                                                Guardar URL
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
}
