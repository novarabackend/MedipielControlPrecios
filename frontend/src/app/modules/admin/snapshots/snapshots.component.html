<div class="flex min-w-0 flex-auto flex-col p-6 sm:p-8">
    <div class="flex flex-wrap items-start justify-between gap-4">
        <div>
            <div class="text-2xl font-semibold tracking-tight">
                Ultimo Price Snapshot
            </div>
            <div class="text-secondary">
                Fecha: {{ snapshotDate() }}
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button
                mat-stroked-button
                type="button"
                (click)="load()"
                [disabled]="loading()"
            >
                Actualizar
            </button>
        </div>
    </div>

    @if (error().length > 0) {
        <div class="mt-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
            {{ error() }}
        </div>
    }

    @if (!hasItems() && !loading()) {
        <div class="mt-6 rounded-xl border border-dashed border-slate-300 bg-white px-6 py-8 text-center text-sm text-secondary">
            No hay snapshots disponibles.
        </div>
    }

    @if (hasItems()) {
        <div class="mt-6 overflow-hidden rounded-2xl border border-slate-200 bg-white">
            <table class="snapshot-table w-full">
                <thead>
                    <tr>
                        <th class="sticky-col" rowspan="2">Producto</th>
                        <th class="sticky-col" rowspan="2">EAN</th>
                        <th class="competitor-group medipiel-group" colspan="2">Medipiel</th>
                        @for (competitor of competitors(); let i = $index; track competitor.id) {
                            <th
                                class="competitor-group"
                                [attr.colspan]="3"
                                [style.backgroundColor]="getCompetitorColor(i, competitor)"
                            >
                                {{ competitor.name }}
                            </th>
                        }
                    </tr>
                    <tr>
                        <th class="competitor-sub medipiel-sub">Precio lista</th>
                        <th class="competitor-sub medipiel-sub">Precio promo</th>
                        @for (competitor of competitors(); let i = $index; track competitor.id) {
                            <th
                                class="competitor-sub"
                                [style.backgroundColor]="getCompetitorColor(i, competitor)"
                            >
                                Precio lista
                            </th>
                            <th
                                class="competitor-sub"
                                [style.backgroundColor]="getCompetitorColor(i, competitor)"
                            >
                                Precio promo
                            </th>
                            <th
                                class="competitor-sub"
                                [style.backgroundColor]="getCompetitorColor(i, competitor)"
                            >
                                URL
                            </th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @for (row of rowsView(); track row.productId) {
                        <tr>
                            <td class="sticky-col">
                                <div class="font-medium">{{ row.description }}</div>
                                <div class="text-xs text-secondary">
                                    Marca: {{ row.brandName ?? '—' }}
                                </div>
                                <div class="text-xs text-secondary">SKU: {{ row.sku ?? '—' }}</div>
                            </td>
                            <td class="sticky-col">{{ row.ean ?? '—' }}</td>
                            <td class="medipiel-cell">
                                @if (row.medipielListPrice !== null && row.medipielListPrice !== undefined) {
                                    {{ row.medipielListPrice | number: '1.0-0' }}
                                } @else {
                                    —
                                }
                            </td>
                            <td class="medipiel-cell">
                                @if (row.medipielPromoPrice !== null && row.medipielPromoPrice !== undefined) {
                                    {{ row.medipielPromoPrice | number: '1.0-0' }}
                                } @else {
                                    —
                                }
                            </td>
                            @for (competitor of competitors(); let i = $index; track competitor.id) {
                                <td
                                    class="competitor-cell"
                                    [style.backgroundColor]="getCompetitorColor(i, competitor)"
                                >
                                    @if (row.pricesByCompetitor[competitor.id]?.listPrice !== null &&
                                    row.pricesByCompetitor[competitor.id]?.listPrice !== undefined) {
                                        <div class="price-stack">
                                            <div class="price-main">
                                                {{ row.pricesByCompetitor[competitor.id]?.listPrice | number: '1.0-0' }}
                                            </div>
                                            @if (
                                            (row.deltaListByCompetitor[competitor.id]?.amount !== null &&
                                            row.deltaListByCompetitor[competitor.id]?.amount !== undefined) ||
                                            (row.deltaListByCompetitor[competitor.id]?.percent !== null &&
                                            row.deltaListByCompetitor[competitor.id]?.percent !== undefined)
                                            ) {
                                                <div
                                                    class="delta-stack"
                                                    [class.delta-up]="(row.deltaListByCompetitor[competitor.id]?.amount ?? 0) > 0"
                                                    [class.delta-down]="(row.deltaListByCompetitor[competitor.id]?.amount ?? 0) < 0"
                                                    [class.delta-flat]="(row.deltaListByCompetitor[competitor.id]?.amount ?? 0) === 0"
                                                >
                                                    <div class="delta-cell">
                                                        <span class="delta-indicator">
                                                            @if (row.deltaListByCompetitor[competitor.id]?.amount > 0) { ▲ } @else if (row.deltaListByCompetitor[competitor.id]?.amount < 0) { ▼ } @else { ● }
                                                        </span>
                                                        <span class="delta-value">
                                                            {{ row.deltaListByCompetitor[competitor.id]?.amount > 0 ? '+' : '' }}{{ row.deltaListByCompetitor[competitor.id]?.amount | number: '1.0-0' }}
                                                        </span>
                                                    </div>
                                                    <div class="delta-sub">
                                                        {{ row.deltaListByCompetitor[competitor.id]?.percent > 0 ? '+' : '' }}{{ row.deltaListByCompetitor[competitor.id]?.percent | number: '1.1-1' }}%
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    } @else {
                                        —
                                    }
                                </td>
                                <td
                                    class="competitor-cell"
                                    [style.backgroundColor]="getCompetitorColor(i, competitor)"
                                >
                                    @if (row.pricesByCompetitor[competitor.id]?.promoPrice !== null &&
                                    row.pricesByCompetitor[competitor.id]?.promoPrice !== undefined) {
                                        <div class="price-stack">
                                            <div class="price-main">
                                                {{ row.pricesByCompetitor[competitor.id]?.promoPrice | number: '1.0-0' }}
                                            </div>
                                            @if (
                                            (row.deltaPromoByCompetitor[competitor.id]?.amount !== null &&
                                            row.deltaPromoByCompetitor[competitor.id]?.amount !== undefined) ||
                                            (row.deltaPromoByCompetitor[competitor.id]?.percent !== null &&
                                            row.deltaPromoByCompetitor[competitor.id]?.percent !== undefined)
                                            ) {
                                                <div
                                                    class="delta-stack"
                                                    [class.delta-up]="(row.deltaPromoByCompetitor[competitor.id]?.amount ?? 0) > 0"
                                                    [class.delta-down]="(row.deltaPromoByCompetitor[competitor.id]?.amount ?? 0) < 0"
                                                    [class.delta-flat]="(row.deltaPromoByCompetitor[competitor.id]?.amount ?? 0) === 0"
                                                >
                                                    <div class="delta-cell">
                                                        <span class="delta-indicator">
                                                            @if (row.deltaPromoByCompetitor[competitor.id]?.amount > 0) { ▲ } @else if (row.deltaPromoByCompetitor[competitor.id]?.amount < 0) { ▼ } @else { ● }
                                                        </span>
                                                        <span class="delta-value">
                                                            {{ row.deltaPromoByCompetitor[competitor.id]?.amount > 0 ? '+' : '' }}{{ row.deltaPromoByCompetitor[competitor.id]?.amount | number: '1.0-0' }}
                                                        </span>
                                                    </div>
                                                    <div class="delta-sub">
                                                        {{ row.deltaPromoByCompetitor[competitor.id]?.percent > 0 ? '+' : '' }}{{ row.deltaPromoByCompetitor[competitor.id]?.percent | number: '1.1-1' }}%
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    } @else {
                                        —
                                    }
                                </td>
                                <td
                                    class="competitor-cell"
                                    [style.backgroundColor]="getCompetitorColor(i, competitor)"
                                >
                                    @if (row.pricesByCompetitor[competitor.id]?.url) {
                                        <a
                                            class="text-primary-700 underline"
                                            [href]="row.pricesByCompetitor[competitor.id]?.url"
                                            target="_blank"
                                        >
                                            Ver producto
                                        </a>
                                    } @else {
                                        —
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>
