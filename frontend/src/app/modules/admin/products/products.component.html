<div class="flex min-w-0 flex-auto flex-col p-6 sm:p-8">
    <div class="flex flex-wrap items-start justify-between gap-4">
        <div>
            <div class="text-2xl font-semibold tracking-tight">Productos</div>
            <div class="text-secondary">
                Carga el catalogo base desde Excel.
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <button mat-stroked-button (click)="downloadTemplate()">
                Descargar plantilla
            </button>
            <button mat-stroked-button (click)="toggleImportPanel()">
                Carga masiva
            </button>
            <button mat-stroked-button (click)="load()">
                Actualizar
            </button>
        </div>
    </div>

    @if (hasError()) {
        <div class="mt-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
            {{ error() }}
        </div>
    }

    @if (showImportPanel()) {
        <div class="bg-card mt-6 rounded-2xl p-6 shadow">
            <div class="text-lg font-medium">Carga masiva</div>
            <div class="text-secondary text-sm">
                Usa la plantilla para cargar SKU, EAN, descripcion, marca, proveedor,
                categoria y linea.
            </div>
            <div class="mt-4 flex flex-wrap items-center gap-4">
                <input type="file" (change)="onFileChange($event)" accept=".xlsx,.xls" />
                <span class="text-sm text-secondary">{{ fileName() }}</span>
                <button
                    mat-flat-button
                    color="primary"
                    (click)="importExcel()"
                    [disabled]="importing()"
                >
                    Importar Excel
                </button>
            </div>

            @if (importSummary()) {
                <div class="mt-4 text-sm text-secondary">
                    Total: {{ importSummary()?.total }} ·
                    Creados: {{ importSummary()?.created }} ·
                    Actualizados: {{ importSummary()?.updated }} ·
                    Fallidos: {{ importSummary()?.failed }}
                </div>
            }

            @if (skippedEmptyRows() > 0) {
                <div class="mt-2 text-sm text-secondary">
                    Filas vacias ignoradas: {{ skippedEmptyRows() }}
                </div>
            }

            @if (importSummary()?.errors?.length) {
                <div class="mt-4 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-800">
                    <div class="font-medium">Errores encontrados</div>
                    <ul class="mt-2 list-disc space-y-1 pl-5">
                        @for (errorItem of importSummary()?.errors ?? []; track errorItem.rowNumber) {
                            <li>
                                Fila {{ errorItem.rowNumber }}:
                                {{ errorItem.message }}
                                @if (errorItem.sku) {
                                    (SKU: {{ errorItem.sku }})
                                }
                            </li>
                        }
                    </ul>
                </div>
            }

            @if (hasImportErrors()) {
                <div class="mt-4">
                    <button mat-stroked-button type="button" (click)="downloadErrors()">
                        Descargar Excel con errores
                    </button>
                </div>
            }

            @if (importSummary()) {
                <div class="mt-6">
                    <div class="text-sm font-medium">Vista previa</div>
                    <div class="text-secondary text-xs">
                        Filas con error resaltadas en rojo.
                    </div>

                    <div class="mt-3 overflow-auto rounded-xl border border-gray-200">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-xs uppercase text-gray-600">
                                <tr>
                                    @for (cell of headerRow(); track $index) {
                                        <th class="px-3 py-2">{{ cell }}</th>
                                    }
                                    <th class="px-3 py-2">Error</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (row of previewRows(); let rowIndex = $index; track rowIndex) {
                                    <tr
                                        [class.bg-red-50]="(errorMap().get(rowIndex + 2) ?? '').length > 0"
                                        [class.text-red-700]="(errorMap().get(rowIndex + 2) ?? '').length > 0"
                                    >
                                        @for (cell of row; track $index) {
                                            <td class="px-3 py-2">{{ cell }}</td>
                                        }
                                        <td class="px-3 py-2">{{ errorMap().get(rowIndex + 2) ?? '' }}</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    @if (hasMorePreview()) {
                        <div class="mt-3">
                            <button mat-stroked-button type="button" (click)="showAllRows()">
                                Mostrar todo
                            </button>
                        </div>
                    }
                </div>
            }
        </div>
    }

    <div class="bg-card mt-6 rounded-2xl p-6 shadow">
        <div class="flex items-center justify-between">
            <div class="text-lg font-medium">Listado</div>
            <div class="text-secondary text-sm">
                Mostrando {{ filteredCount() }} de {{ items().length }}
            </div>
        </div>

        <div class="mt-4 grid gap-4 lg:grid-cols-7">
            <mat-form-field class="w-full">
                <mat-label>EAN</mat-label>
                <input
                    matInput
                    placeholder="Buscar por EAN"
                    [value]="filterEan()"
                    (input)="filterEan.set($any($event.target).value)"
                />
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Nombre</mat-label>
                <input
                    matInput
                    placeholder="Buscar por descripcion"
                    [value]="filterName()"
                    (input)="filterName.set($any($event.target).value)"
                />
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Marca</mat-label>
                <mat-select
                    [value]="filterBrand()"
                    (selectionChange)="filterBrand.set($any($event.value))"
                >
                    <mat-option value="">Todas</mat-option>
                    @for (item of brands(); track item.id) {
                        <mat-option [value]="item.name">{{ item.name }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Proveedor</mat-label>
                <mat-select
                    [value]="filterSupplier()"
                    (selectionChange)="filterSupplier.set($any($event.value))"
                >
                    <mat-option value="">Todos</mat-option>
                    @for (item of suppliers(); track item.id) {
                        <mat-option [value]="item.name">{{ item.name }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Categoria</mat-label>
                <mat-select
                    [value]="filterCategory()"
                    (selectionChange)="filterCategory.set($any($event.value))"
                >
                    <mat-option value="">Todas</mat-option>
                    @for (item of categories(); track item.id) {
                        <mat-option [value]="item.name">{{ item.name }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Linea</mat-label>
                <mat-select
                    [value]="filterLine()"
                    (selectionChange)="filterLine.set($any($event.value))"
                >
                    <mat-option value="">Todas</mat-option>
                    @for (item of lines(); track item.id) {
                        <mat-option [value]="item.name">{{ item.name }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Competidor</mat-label>
                <mat-select
                    [value]="filterCompetitor()"
                    (selectionChange)="filterCompetitor.set($any($event.value))"
                >
                    <mat-option [value]="null">Todos</mat-option>
                    @for (item of competitors(); track item.id) {
                        <mat-option [value]="item.id">{{ item.name }}</mat-option>
                    }
                </mat-select>
            </mat-form-field>

            <mat-form-field class="w-full">
                <mat-label>Estado</mat-label>
                <mat-select
                    [value]="filterStatus()"
                    (selectionChange)="filterStatus.set($any($event.value))"
                >
                    <mat-option value="all">Todos</mat-option>
                    <mat-option value="matched">Con match</mat-option>
                    <mat-option value="unmatched">Sin match</mat-option>
                    <mat-option value="no-ean">Sin EAN</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="mt-2">
            <button mat-stroked-button type="button" (click)="resetFilters()">
                Limpiar filtros
            </button>
            <button
                class="ml-2"
                mat-stroked-button
                type="button"
                (click)="exportExcel()"
                [disabled]="filteredItems().length === 0"
            >
                Exportar Excel
            </button>
        </div>

        <div class="stats mt-4 grid gap-4 lg:grid-cols-4">
            <div class="stat-card">
                <div class="stat-label">Productos monitoreados</div>
                <div class="stat-value">{{ totalCount() }}</div>
                <div class="stat-sub">Corte: {{ snapshotDate() }}</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Match total</div>
                <div class="stat-value">{{ matchPercent() | number: '1.1-1' }}%</div>
                <div class="stat-sub">
                    {{ matchCount() }} con match ({{ getCompetitorLabel() }})
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Alertas brecha &gt; 8%</div>
                <div class="stat-value">{{ alertCount() }}</div>
                <div class="stat-sub">Segun competidor seleccionado</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Productos sin EAN</div>
                <div class="stat-value">{{ noEanCount() }}</div>
                <div class="stat-sub">Revisar catalogo</div>
            </div>
        </div>

        @if (loading()) {
            <div class="text-secondary mt-4">Cargando...</div>
        } @else {
            @if (filteredItems().length === 0) {
                <div class="text-secondary mt-4">No hay productos para ese filtro.</div>
            } @else {
                <table mat-table [dataSource]="filteredItems()" class="mt-4 w-full">
                    <ng-container matColumnDef="sku">
                        <th mat-header-cell *matHeaderCellDef>SKU</th>
                        <td mat-cell *matCellDef="let row">{{ row.sku }}</td>
                    </ng-container>

                    <ng-container matColumnDef="ean">
                        <th mat-header-cell *matHeaderCellDef>EAN</th>
                        <td mat-cell *matCellDef="let row">{{ row.ean ?? '—' }}</td>
                    </ng-container>

                    <ng-container matColumnDef="brand">
                        <th mat-header-cell *matHeaderCellDef>Marca</th>
                        <td mat-cell *matCellDef="let row">{{ row.brandName ?? '—' }}</td>
                    </ng-container>

                    <ng-container matColumnDef="supplier">
                        <th mat-header-cell *matHeaderCellDef>Proveedor</th>
                        <td mat-cell *matCellDef="let row">{{ row.supplierName ?? '—' }}</td>
                    </ng-container>

                    <ng-container matColumnDef="category">
                        <th mat-header-cell *matHeaderCellDef>Categoria</th>
                        <td mat-cell *matCellDef="let row">{{ row.categoryName ?? '—' }}</td>
                    </ng-container>

                    <ng-container matColumnDef="line">
                        <th mat-header-cell *matHeaderCellDef>Linea</th>
                        <td mat-cell *matCellDef="let row">{{ row.lineName ?? '—' }}</td>
                    </ng-container>

                    <ng-container matColumnDef="description">
                        <th mat-header-cell *matHeaderCellDef>Descripcion</th>
                        <td mat-cell *matCellDef="let row">
                            <div class="description-cell">
                                <div class="font-medium">{{ row.description }}</div>
                                <a
                                    class="mt-2 inline-flex text-sm font-medium text-primary-700 underline"
                                    [routerLink]="['/catalog/products', row.id]"
                                >
                                    Ver detalle
                                </a>
                                <div class="hover-preview">
                                    <div class="hover-header">
                                        <img
                                            src="https://medipielsa.vtexassets.com/arquivos/ids/263270-1600-auto?v=638781829135000000&width=1600&height=auto&aspect=true"
                                            alt="Producto"
                                        />
                                        <div>
                                            <div class="hover-title">{{ row.description }}</div>
                                            <div class="hover-sub">
                                                SKU {{ row.sku }} ·
                                                EAN {{ row.ean ?? '—' }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="hover-list">
                                        <div class="hover-item">
                                            <span>Medipiel</span>
                                            <span>
                                                @if (row.medipielListPrice !== null && row.medipielListPrice !== undefined) {
                                                    {{ row.medipielListPrice | number: '1.0-0' }}
                                                } @else {
                                                    —
                                                }
                                            </span>
                                        </div>
                                        @for (comp of hoverCompetitors(); track comp.id) {
                                            <div class="hover-item">
                                                <span>{{ comp.name }}</span>
                                                <span>
                                                    @if (row.pricesByCompetitor[comp.id]?.listPrice !== null &&
                                                    row.pricesByCompetitor[comp.id]?.listPrice !== undefined) {
                                                        {{ row.pricesByCompetitor[comp.id]?.listPrice | number: '1.0-0' }}
                                                    } @else {
                                                        —
                                                    }
                                                </span>
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                </table>
            }
        }
    </div>
</div>
