<div class="flex min-w-0 flex-auto flex-col p-6 sm:p-8">
    <div class="flex flex-wrap items-start justify-between gap-4">
        <div>
            <div class="text-2xl font-semibold tracking-tight">Dashboard diario</div>
            <div class="text-secondary">
                Ultima actualizacion: {{ snapshotDate() }}
            </div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
            <button mat-stroked-button type="button" (click)="load()">
                Actualizar
            </button>
        </div>
    </div>

    @if (error().length > 0) {
        <div class="mt-4 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
            {{ error() }}
        </div>
    }

    <div class="filters mt-6 grid gap-4 lg:grid-cols-4">
        <div class="filter-card">
            <span>Fecha de analisis</span>
            <strong>{{ snapshotDate() }}</strong>
        </div>
        <div class="filter-card">
            <span>Catalogo activo</span>
            <strong>—</strong>
        </div>
        <mat-form-field class="w-full">
            <mat-label>Categoria</mat-label>
            <mat-select
                [value]="filterCategory()"
                (selectionChange)="filterCategory.set($any($event.value))"
            >
                <mat-option value="">Todas</mat-option>
                @for (item of categories(); track item.id) {
                    <mat-option [value]="item.name">{{ item.name }}</mat-option>
                }
            </mat-select>
        </mat-form-field>
        <mat-form-field class="w-full">
            <mat-label>Buscar</mat-label>
            <input
                matInput
                placeholder="SKU / EAN / nombre"
                [value]="filterSearch()"
                (input)="filterSearch.set($any($event.target).value)"
            />
        </mat-form-field>
    </div>

    <div class="mt-2">
        <button mat-stroked-button type="button" (click)="resetFilters()">
            Limpiar filtros
        </button>
    </div>

    <div class="mt-6 grid gap-4 lg:grid-cols-3">
        <div class="card kpi">
            <div class="kpi-label">Productos monitoreados</div>
            <div class="kpi-value">{{ totalProducts() }}</div>
            <div class="kpi-sub">Corte: {{ snapshotDate() }}</div>
        </div>
        <div class="card kpi">
            <div class="kpi-label">Match total (EAN + IA)</div>
            <div class="kpi-value">{{ matchPercent() | number: '1.1-1' }}%</div>
            <div class="kpi-sub">{{ matchCount() }} productos con match</div>
        </div>
        <div class="card kpi">
            <div class="kpi-label">Dif prom vs competencia</div>
            <div class="kpi-value">
                @if (avgGapPercent() !== null) {
                    {{ avgGapPercent() | number: '1.1-1' }}%
                } @else {
                    —
                }
            </div>
            <div class="kpi-sub">
                @if (avgGapPercent() !== null) {
                    {{ avgGapPercent() < 0 ? 'Medipiel mas barato' : 'Medipiel mas caro' }}
                } @else {
                    —
                }
            </div>
        </div>
    </div>

    <div class="mt-6 grid gap-4 lg:grid-cols-3">
        <div class="card lg:col-span-2">
            <div class="card-title">Brecha por competidor</div>
            <div class="competitors">
                @for (item of competitorSummaries(); track item.competitor.id) {
                    <div class="competitor-card">
                        <div class="competitor-name">
                            {{ item.competitor.name }}
                        </div>
                        <div class="competitor-value">
                            Promedio:
                            @if (item.avgGapPercent !== null) {
                                {{ item.avgGapPercent | number: '1.1-1' }}%
                            } @else {
                                —
                            }
                        </div>
                        <div class="competitor-sub">
                            Productos mas caros: {{ item.higherCount }}
                        </div>
                        <div class="competitor-sub">
                            Promociones activas: {{ item.promoCount }}
                        </div>
                    </div>
                }
            </div>
        </div>
        <div class="card">
            <div class="card-title">Alertas de precio</div>
            <div class="list">
                <div class="list-item">
                    <span>
                        {{ alertsSummary().gapProducts }} productos con diferencia
                        > 8%
                    </span>
                    <span class="pill">Revisar</span>
                </div>
                @for (entry of alertsSummary().noMatchByCompetitor; track entry.competitor.id) {
                    <div class="list-item">
                        <span>
                            {{ entry.count }} productos sin match en
                            {{ entry.competitor.name }}
                        </span>
                        <span class="pill">Pendiente</span>
                    </div>
                }
            </div>
            <div class="list-footer">
                Sin EAN: {{ noEanCount() }}
            </div>
        </div>
    </div>

    <div class="mt-6 grid gap-4 lg:grid-cols-3">
        <div class="card lg:col-span-2">
            <div class="card-title">Historico de brecha (7 dias)</div>
            <div class="chart">
                @if (trendSeries().length === 0) {
                    <div class="text-secondary text-sm">Sin datos de tendencia.</div>
                } @else {
                    <svg viewBox="0 0 600 160" preserveAspectRatio="none">
                        <line class="grid" x1="20" y1="20" x2="580" y2="20"></line>
                        <line class="grid" x1="20" y1="60" x2="580" y2="60"></line>
                        <line class="grid" x1="20" y1="100" x2="580" y2="100"></line>
                        <line class="grid" x1="20" y1="140" x2="580" y2="140"></line>
                        <line class="axis" x1="20" y1="20" x2="20" y2="140"></line>
                        <line class="axis" x1="20" y1="140" x2="580" y2="140"></line>

                        @for (series of trendSeries(); track series.competitor.id) {
                            <polyline
                                [attr.points]="series.points"
                                [attr.stroke]="series.competitor.color ?? '#0c2a3a'"
                                fill="none"
                                stroke-width="2"
                            ></polyline>
                        }
                    </svg>
                }
            </div>
            <div class="legend">
                @for (series of trendSeries(); track series.competitor.id) {
                    <div class="legend-item">
                        <span
                            class="dot"
                            [style.backgroundColor]="series.competitor.color ?? '#0c2a3a'"
                        ></span>
                        {{ series.competitor.name }}
                    </div>
                }
            </div>
        </div>
        <div class="card">
            <div class="card-title">Cola de nuevos productos</div>
            <div class="list">
                <div class="list-item">
                    <span>{{ noEanCount() }} productos sin EAN</span>
                    <span class="pill">Revisar</span>
                </div>
                <div class="list-item">
                    <span>{{ totalProducts() }} productos en catalogo</span>
                    <span class="pill">Activo</span>
                </div>
            </div>
            <div class="list-footer">
                Ultimo corte: {{ snapshotDate() }}
            </div>
        </div>
    </div>
</div>
